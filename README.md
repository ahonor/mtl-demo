The example shown here models a hypothetical application called
"Guitars", a simple web-based service using several functional roles
like web, app and database services.

The purpose of this example is to show how dev and ops teams can
collaborate around how to restart the web tier, manage software
promotions, run status health checks and a nightly batch job.

This is a single-machine vagrant configuration that installs
and configures a rundeck instance and an Apache httpd instance.

The httpd instance is used as a simple web-based file
repository from which scripts and job options are shared to Rundeck. 


To run this example, you will bring up a VM using vagrant, log in 
to Rundeck and perform certain jobs.

## Vagrant configuration

This vagrant configuration defines one virtual machine:

* **rundeck**: The rundeck instance used by all the teams.
* **app1**: Target node where the application deployments reside.

The rundeck VMs run a centos base box and installs software via yum/rpm.


### Requirements

* Internet access to download packages from public repositories.
* [Vagrant 1.2.2](http://downloads.vagrantup.com)

### Startup

Start up the VMs like so:

    vagrant up

You can access the rundeck and httpd instances from your host machine using the following URLs:

* rundeck: http://192.168.50.2:4440
* httpd: http://192.168.50.2/guitars


## Nodes

The guitars project contains several nodes. Go to the "Nodes" page and press the button
"Show all nodes". You will see the following nodes:

* app1
* app2
* db1
* www1
* www2

Each of the nodes play a role in running the Guitars application.

The Tags columns shows how each node is tagged with user defined
labels. You can use tags for grouping or classification.
For example, all of the nodes tagged "guitars" represent the
guitars hosts.
There are also tags that describe functionally like "www" and "app" and "db".
Clicking on any of the tag names filters the nodes for ones that are tagged with that label.
Clicking on the "guitars" tag will list all the guitars nodes again.



### Jobs

The rundeck instance will come up with the following demo jobs 
already loaded. All jobs are organized under a common group called "guitars".

- Promote - 'promote the packages'
- web/Restart - 'restart the web servers'
- Status - 'Check the status of guitars'
- nightly_catalog_rebuild - 'rebuild the catalog data'
- web/start - 'start the web servers'
- web/stop - 'stop the web servers'

Each job is defined in its own file using the 
[XML format](http://rundeck.org/docs/manpages/man5/job-v20.html). 
[YAML](http://rundeck.org/docs/manpages/man5/job-yaml-v12.html) could also have been used as an alternative syntax. Rundeck jobs can call
scripts stored in a web server by specifying its location with a 
[scripturl](http://rundeck.org/docs/manpages/man5/job-v20.html#script-sequence-step).
Storing scripts outside of a rundeck job, faciliates better collaboration
and configuration management.

Using job groups is optional but is often helpful to organize procedures
and simplify setting up ACL policies.

#### Promote

The Promote job is run by the Release Engeering team to publish artifacts from
upstream repositories to ones used by operations.

A key part to the promote job is a user interface that lets users manage a hierarchical set of job choices.
The Promote job prompts the user for several choices about which package versions to publish
in the ops package repo. 
The `option` elements specified in the Promote job definition read choices from the 
[valuesUrl](http://rundeck.org/docs/manpages/man5/job-v20.html#valuesurl-json), which returns JSON data consumable by rundeck. This JSON can be static
files like in this example, but more typically is generated by an external service or tool.

The Promote job contains a trivial script which simply prints out the job runner's choices
but does show how a script can access options data set by the job.

* [job source](https://github.com/rundeck/guitars-demo/blob/master/jobs/Promote.xml)

#### Restart

The Restart job is run by the Operations team to manage the web tier's restart procedure.

The Restart job includes a "method" option to support the two methods to stop the web servers, "normal" and "force".
Also, because the location of the application installation directory is expected to
vary, a "dir" option is also presented. 

This job is defined to execute on nodes tagged "www". The Restart job actually builds on two lower level jobs, web/stop and web/start. This kind of job composition is typical for rundeck users as it gives them building blocks to create higher levels of automation later.

* [job source](https://github.com/rundeck/guitars-demo/blob/master/jobs/Restart.xml)

#### Status

The Status job is used by both Developers and Operations to get a heath check of the
web tier.

The Status job executes a procedure written by the devs to check the health of the web tier.
By default, rundeck jobs stop if a failure occurs. This Status job takes advantage of rundeck
[step error handlers](http://rundeck.org/docs/manual/job-workflows.html#error-handlers) to continue going to the next node if the status check fails.

This job is defined to execute on nodes tagged "www".

* [job source](https://github.com/rundeck/guitars-demo/blob/master/jobs/Status.xml)

#### nightly_catalog_rebuild

The nightly_catalog_rebuild job is provided by developers to run automatically every night.

The nightly_catalog_rebuild job is meant to run at 00:00:00 (midnight) every day.
The [schedule](http://rundeck.org/docs/manpages/man5/job-v20.html#schedule) element in the job definition specifies this in a crontab like format.
Also, the [notification](http://rundeck.org/docs/manpages/man5/job-v20.html#notification) element is used to send emails upon success and failure to the 
"bizops@guitars.com" mail group.

The script for this job runs on the database server tagged "db". The script
is written to use 
[context variables](http://rundeck.org/docs/manual/job-workflows.html#context-variables)
which exposes metadata about the job and node information from the resource model. 
Attributes about the node
are exposed as environment variables to the script. For example, the db
node has two custom attributes: guitars-customer and guitars-location. The
values of these metadata attributes can be read by the script as environment variables:
`RD_NODE_GUITARS_CUSTOMER` and `RD_NODE_GUITARS_LOCATION`.

* [job source](https://github.com/rundeck/guitars-demo/blob/master/jobs/nightly_catalog_rebuild.xml)

